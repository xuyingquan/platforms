server {
    include ../../env/hsm.listen;
    {% for domain in domains -%}
    server_name {{ domain.domain }};
    {% endfor %}

    set $channel {{ channel_id }};

    set $ant_upstream uce_backend;
    {% if consistent_key %}
    set $ant_consistent_key {{ consistent_key }};
    {% endif %}

    {% for location in locations -%}
    location {{ location.location }} {
        {% if location.access_lua and location.access_lua != '' -%}
        access_by_lua_file ../sp_lua/{{ sp_code }}/{{ location.access_lua }};
        {% else %}
        access_by_lua_file ../comm/access.lua;
        {% endif %}

        {% if location.limit_rate -%}
        proxy_buffering on;
        proxy_max_temp_file_size 0;
        {% endif %}

        {% if location.limit_rate_after -%}
        limit_rate_after {{ location.limit_rate_after }};
        {% endif %}

        {% if location.slice -%}
        {% if location.slice_size -%}
        proxy_set_header X-Slice-Size {{ location.slice_size }};
        {% else %}
        proxy_set_header X-Slice-Size "1m";
        {% endif %}
        {% endif %}

        {% if not location.cache_lock -%}
        proxy_set_header X-Cache-Lock "off";
        {% else -%}
        proxy_set_header X-Lock-age "20s";
        proxy_set_header X-Lock-Timeout "5s";
        {% endif %}

        {% if location.precise -%}
        include ../../env/precise.conf;
        {% endif %}

        {% if location.auth -%}
        include ../../env/auth.conf;
        {% endif %}

        proxy_http_version 1.1;
        proxy_cache off;
        proxy_redirect off ;
        proxy_set_header Connection Keep-Alive;
        proxy_set_header Host $host;
        proxy_set_header X-Channel $channel;
        proxy_set_header If-None-Match "";
        proxy_set_header If-Modified-Since "";

        {% if location.mp4 -%}
        proxy_mp4_seek on;
        proxy_buffer_size {{ location.mp4_buf_size }};
        proxy_buffers 64 {{ location.mp4_buf_size }};
        mp4_seek_buffer_size {{ location.mp4_buf_size }};
        mp4_seek_start {{ location.mp4_seek_start }};
        mp4_seek_end {{ location.mp4_seek_end }};
        proxy_set_header Range $mp4_range;
        proxy_pass http://$ant_upstream$uri$is_mp4_args$mp4_args;
        {% else %}
        proxy_pass http://$ant_upstream$uri$is_args$args;
        {% endif %}

        proxy_next_upstream http_500;
        proxy_next_upstream_tries 3;

        {% if location.header_filter_lua and location.header_filter_lua != '' -%}
        header_filter_by_lua_file ../sp_lua/{{ sp_code }}/{{ location.header_filter_lua }};
        {% endif %}

        {% if location.body_filter_lua and location.body_filter_lua != '' -%}
        body_filter_by_lua_file ../sp_lua/{{ sp_code }}/{{ location.body_filter_lua }};
        {% endif %}
    }
    {% endfor %}

    location = /precise {
        internal;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        proxy_send_timeout 2s;
        proxy_pass_request_body off;
        proxy_set_header Connection Keep-Alive;

        proxy_set_header Host dg.shatacloud.com;
        proxy_pass http://hrb_backend/?host=$host&service_addr=$http_x_server_addr&remote_addr=$http_x_remote_addr;
    }

    {% if auth_type and auth_type != '' -%}
    location = /auth {
        internal;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        proxy_send_timeout 2s;
        proxy_pass_request_body off;
        proxy_set_header Connection Keep-Alive;

        proxy_set_header Sp-Channel $channel;
        proxy_set_header X-Remote-Addr $http_x_remote_addr;
        proxy_set_header X-Remote-Uri $request_uri;
        proxy_set_header HotLink-Type {{ auth_type }};
        proxy_set_header Host $host;

        proxy_pass http://auth_backend;
    }
    {% endif %}

    location = /bodyauth {
        internal;

        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        proxy_send_timeout 2s;
        proxy_pass_request_body off;

        proxy_http_version 1.1;

        proxy_set_header Connection Keep-Alive;
        proxy_set_header User-Agent Hsm-M3u8-Auth;
        proxy_set_header Host $host;

        proxy_pass http://$http_x_m3u8_uri;

        body_filter_by_lua_file ../sp_lua/{{ sp_code }}/body_auth.lua;
    }
}
