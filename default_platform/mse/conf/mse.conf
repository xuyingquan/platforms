user  root;
worker_processes auto;

error_log /data/logs/mse/error.log error;
worker_rlimit_core   5G;
worker_rlimit_nofile 131071;
pid logs/mse.pid;

events {
    accept_mutex  off;
    worker_connections  8192;
}

http {
    include       ../../comm/mime.types;
    default_type  text/html;

    log_format main '$http_x_session_id|$channel|$msec|$request_method|$request_uri|'
                    '$status|$response_time|$response_header_length|$segment_bytes_sent|$upstream_cache_status|'
                    '$remote_port|$remote_addr|$label|$node|$http_referer|'
                    '$upstream_response_time|$request_length|$http_user_agent|$host|$upstream_connect_time|'
                    '$scheme|$segment_duration|$remote_user|$server_addr|$server_port|'
                    '$msec_first|$bytes_sent|$segment_type|$upstream_addr|-|'
                    '$http_range|$server_protocol|$body_bytes_sent|$request_time';

    access_log /data/logs/mse/access.log main;

    sendfile       on;
    tcp_nopush     off;
    tcp_nodelay    on;
    keepalive_requests 50000;
    keepalive_timeout 100;
    client_body_buffer_size 512k;
    proxy_connect_timeout 5;
    proxy_read_timeout 20;
    proxy_send_timeout 5;
    proxy_buffer_size 16k;

    gzip on;
    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    proxy_buffers 4 64k;
    proxy_busy_buffers_size 128k;
    proxy_temp_file_write_size 512k;
    proxy_intercept_errors on;  # 302 redirect
    client_max_body_size 10M;
    server_names_hash_bucket_size 256;

    proxy_purge_zone cache_zone=purge_zone:1024M;

    proxy_cache_path /data/1/mse levels=1:2 use_temp_path=off keys_zone=data_9101:60m inactive=365d max_size=300g;
    proxy_cache_path /data/2/mse levels=1:2 use_temp_path=off keys_zone=data_9102:60m inactive=365d max_size=300g;
    proxy_cache_path /data/3/mse levels=1:2 use_temp_path=off keys_zone=data_9103:60m inactive=365d max_size=300g;
    proxy_cache_path /data/4/mse levels=1:2 use_temp_path=off keys_zone=data_9104:60m inactive=365d max_size=300g;
    proxy_cache_path /data/5/mse levels=1:2 use_temp_path=off keys_zone=data_9105:60m inactive=365d max_size=300g;
    proxy_cache_path /data/6/mse levels=1:2 use_temp_path=off keys_zone=data_9106:60m inactive=365d max_size=300g;
    proxy_cache_path /data/7/mse levels=1:2 use_temp_path=off keys_zone=data_9107:60m inactive=365d max_size=300g;
    proxy_cache_path /data/8/mse levels=1:2 use_temp_path=off keys_zone=data_9108:60m inactive=365d max_size=300g;
    proxy_cache_path /data/9/mse levels=1:2 use_temp_path=off keys_zone=data_9109:60m inactive=365d max_size=300g;
    proxy_cache_path /data/10/mse levels=1:2 use_temp_path=off keys_zone=data_9110:60m inactive=365d max_size=300g;
    proxy_cache_path /data/11/mse levels=1:2 use_temp_path=off keys_zone=data_9111:60m inactive=365d max_size=300g;
    proxy_cache_path /data/12/mse levels=1:2 use_temp_path=off keys_zone=data_9112:60m inactive=365d max_size=300g;
    proxy_cache_path /data/13/mse levels=1:2 use_temp_path=off keys_zone=data_9113:60m inactive=365d max_size=300g;
    proxy_cache_path /data/14/mse levels=1:2 use_temp_path=off keys_zone=data_9114:60m inactive=365d max_size=300g;
    proxy_cache_path /data/15/mse levels=1:2 use_temp_path=off keys_zone=data_9115:60m inactive=365d max_size=300g;
    proxy_cache_path /data/16/mse levels=1:2 use_temp_path=off keys_zone=data_9116:60m inactive=365d max_size=300g;
    proxy_cache_path /data/17/mse levels=1:2 use_temp_path=off keys_zone=data_9117:60m inactive=365d max_size=300g;
    proxy_cache_path /data/18/mse levels=1:2 use_temp_path=off keys_zone=data_9118:60m inactive=365d max_size=300g;
    proxy_cache_path /data/19/mse levels=1:2 use_temp_path=off keys_zone=data_9119:60m inactive=365d max_size=300g;
    proxy_cache_path /data/20/mse levels=1:2 use_temp_path=off keys_zone=data_9120:60m inactive=365d max_size=300g;
    proxy_cache_path /data/21/mse levels=1:2 use_temp_path=off keys_zone=data_9121:60m inactive=365d max_size=300g;
    proxy_cache_path /data/22/mse levels=1:2 use_temp_path=off keys_zone=data_9122:60m inactive=365d max_size=300g;
    proxy_cache_path /data/23/mse levels=1:2 use_temp_path=off keys_zone=data_9123:60m inactive=365d max_size=300g;
    proxy_cache_path /data/24/mse levels=1:2 use_temp_path=off keys_zone=data_9124:60m inactive=365d max_size=300g;

    lua_package_path '${prefix}/conf/?.lua;${prefix}/../../lualib/?.lua;/opt/ant/lualib/?.lua;;';
    lua_package_cpath '/opt/ant/lualib/?.so;;';
    lua_shared_dict trigerdownload 30m;
    lua_max_running_timers 100000;

    init_by_lua_block {
        local frame = require "ant.frame"
        frame.initFrame()
    }

    init_worker_by_lua_block {
        local frame = require "ant.frame"
        frame.initWorker()
    }

    upstream mse_upstream {
        server 0.0.0.1;
        balancer_by_lua_file conf/balancer.lua;
        keepalive 100;    
    }

    server {
         
        include ../../env/mse.listen;

        location / {

            access_by_lua_file conf/access.lua;

            proxy_cache_lock off;
            proxy_cache data_$server_port;

            proxy_cache_division $http_x_cache_division;
            proxy_cache_key $http_x_cache_key$http_range;
            proxy_cache_valid 200 206 730d;

            proxy_redirect off;
            proxy_cache_revalidate on;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection Keep-Alive;
            proxy_set_header Range $http_range;

            proxy_pass http://mse_upstream;

            header_filter_by_lua_file conf/header_filter.lua;
        }
    }

#include admin.conf;
}
