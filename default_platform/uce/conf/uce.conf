user  root;
worker_processes auto;

error_log /data/logs/uce/error.log error;
worker_rlimit_core   10G;
worker_rlimit_nofile 327675;
pid logs/uce.pid;

events {
    accept_mutex  off;
    worker_connections  8192;
}

http {
    include       ../../comm/mime.types;
    default_type  text/html;

    log_format main '$http_x_session_id|$channel|$msec|$request_method|$request_uri|'
                    '$status|$response_time|$response_header_length|$segment_bytes_sent|$upstream_cache_status|'
                    '$remote_port|$remote_addr|$label|$node|$http_referer|'
                    '$upstream_response_time|$request_length|$http_user_agent|$host|$upstream_connect_time|'
                    '$scheme|$segment_duration|$remote_user|$server_addr|$server_port|'
                    '$msec_first|$bytes_sent|$segment_type|$upstream_addr|-|'
                    '$http_range|$server_protocol|$body_bytes_sent|$request_time';

    include ../../env/uce_accesslog.conf;

    sendfile       on;
    tcp_nopush     off;
    tcp_nodelay    on;
    keepalive_requests 50000;
    keepalive_timeout 100;
    client_body_buffer_size 512k;
    proxy_connect_timeout 5;
    proxy_read_timeout 20;
    proxy_send_timeout 5;
    proxy_buffer_size 16k;

    gzip on;
    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    proxy_buffers 4 64k;
    proxy_busy_buffers_size 128k;
    proxy_temp_file_write_size 512k;
    proxy_intercept_errors on;  # 302 redirect
    client_max_body_size 10M;
    server_names_hash_bucket_size 256;

    proxy_purge_zone cache_zone=purge_zone:1024M proxy_pass=on;

    proxy_cache_path /data/1/cachet levels=1:2 use_temp_path=off keys_zone=data_9101:128m inactive=365d max_size=350g;
    proxy_cache_path /data/2/cachet levels=1:2 use_temp_path=off keys_zone=data_9102:128m inactive=365d max_size=350g;
    proxy_cache_path /data/3/cachet levels=1:2 use_temp_path=off keys_zone=data_9103:128m inactive=365d max_size=350g;
    proxy_cache_path /data/4/cachet levels=1:2 use_temp_path=off keys_zone=data_9104:128m inactive=365d max_size=350g;
    proxy_cache_path /data/5/cachet levels=1:2 use_temp_path=off keys_zone=data_9105:128m inactive=365d max_size=350g;
    proxy_cache_path /data/6/cachet levels=1:2 use_temp_path=off keys_zone=data_9106:128m inactive=365d max_size=350g;
    proxy_cache_path /data/7/cachet levels=1:2 use_temp_path=off keys_zone=data_9107:128m inactive=365d max_size=350g;
    proxy_cache_path /data/8/cachet levels=1:2 use_temp_path=off keys_zone=data_9108:128m inactive=365d max_size=350g;
    proxy_cache_path /data/9/cachet levels=1:2 use_temp_path=off keys_zone=data_9109:128m inactive=365d max_size=350g;
    proxy_cache_path /data/10/cachet levels=1:2 use_temp_path=off keys_zone=data_9110:128m inactive=365d max_size=350g;
    proxy_cache_path /data/11/cachet levels=1:2 use_temp_path=off keys_zone=data_9111:128m inactive=365d max_size=350g;
    proxy_cache_path /data/12/cachet levels=1:2 use_temp_path=off keys_zone=data_9112:128m inactive=365d max_size=350g;
    proxy_cache_path /data/13/cachet levels=1:2 use_temp_path=off keys_zone=data_9113:128m inactive=365d max_size=350g;
    proxy_cache_path /data/14/cachet levels=1:2 use_temp_path=off keys_zone=data_9114:128m inactive=365d max_size=350g;
    proxy_cache_path /data/15/cachet levels=1:2 use_temp_path=off keys_zone=data_9115:128m inactive=365d max_size=350g;
    proxy_cache_path /data/16/cachet levels=1:2 use_temp_path=off keys_zone=data_9116:128m inactive=365d max_size=350g;
    proxy_cache_path /data/17/cachet levels=1:2 use_temp_path=off keys_zone=data_9117:128m inactive=365d max_size=350g;
    proxy_cache_path /data/18/cachet levels=1:2 use_temp_path=off keys_zone=data_9118:128m inactive=365d max_size=350g;
    proxy_cache_path /data/19/cachet levels=1:2 use_temp_path=off keys_zone=data_9119:128m inactive=365d max_size=350g;
    proxy_cache_path /data/20/cachet levels=1:2 use_temp_path=off keys_zone=data_9120:128m inactive=365d max_size=350g;
    proxy_cache_path /data/21/cachet levels=1:2 use_temp_path=off keys_zone=data_9121:128m inactive=365d max_size=350g;
    proxy_cache_path /data/22/cachet levels=1:2 use_temp_path=off keys_zone=data_9122:128m inactive=365d max_size=350g;
    proxy_cache_path /data/23/cachet levels=1:2 use_temp_path=off keys_zone=data_9123:128m inactive=365d max_size=350g;
    proxy_cache_path /data/24/cachet levels=1:2 use_temp_path=off keys_zone=data_9124:128m inactive=365d max_size=350g;

    # prefetch
    proxy_cache_path /data/1/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9101:10m inactive=365d max_size=5g;
    proxy_cache_path /data/2/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9102:10m inactive=365d max_size=5g;
    proxy_cache_path /data/3/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9103:10m inactive=365d max_size=5g;
    proxy_cache_path /data/4/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9104:10m inactive=365d max_size=5g;
    proxy_cache_path /data/5/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9105:10m inactive=365d max_size=5g;
    proxy_cache_path /data/6/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9106:10m inactive=365d max_size=5g;
    proxy_cache_path /data/7/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9107:10m inactive=365d max_size=5g;
    proxy_cache_path /data/8/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9108:10m inactive=365d max_size=5g;
    proxy_cache_path /data/9/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9109:10m inactive=365d max_size=5g;
    proxy_cache_path /data/10/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9110:10m inactive=365d max_size=5g;
    proxy_cache_path /data/11/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9111:10m inactive=365d max_size=5g;
    proxy_cache_path /data/12/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9112:10m inactive=365d max_size=5g;
    proxy_cache_path /data/13/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9113:10m inactive=365d max_size=5g;
    proxy_cache_path /data/14/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9114:10m inactive=365d max_size=5g;
    proxy_cache_path /data/15/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9115:10m inactive=365d max_size=5g;
    proxy_cache_path /data/16/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9116:10m inactive=365d max_size=5g;
    proxy_cache_path /data/17/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9117:10m inactive=365d max_size=5g;
    proxy_cache_path /data/18/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9118:10m inactive=365d max_size=5g;
    proxy_cache_path /data/19/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9119:10m inactive=365d max_size=5g;
    proxy_cache_path /data/20/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9120:10m inactive=365d max_size=5g;
    proxy_cache_path /data/21/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9121:10m inactive=365d max_size=5g;
    proxy_cache_path /data/22/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9122:10m inactive=365d max_size=5g;
    proxy_cache_path /data/23/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9123:10m inactive=365d max_size=5g;
    proxy_cache_path /data/24/prefetch levels=1:2 use_temp_path=off keys_zone=data2_9124:10m inactive=365d max_size=5g;

    lua_package_path '${prefix}/conf/?.lua;${prefix}/../../lualib/?.lua;/opt/ant/lualib/?.lua;;';
    lua_package_cpath '/opt/ant/lualib/?.so;;';
    lua_shared_dict healthcheck 10m;

    init_by_lua_block {
        local frame = require "ant.frame"
        frame.initFrame()
    }

    init_worker_by_lua_block {
        local frame = require "ant.frame"
        frame.initWorker()
    }

    upstream default_backend {
        server 0.0.0.1;
        balancer_by_lua_file conf/balancer.lua;
        keepalive 100;
    } 

    server {
         
        include ../../env/uce.listen;

        location / {
            access_by_lua_file conf/access.lua;

            slice $http_x_slice_size;
            proxy_set_header Range $slice_range;

            proxy_http_version 1.1;

            proxy_cache_lock on;
            proxy_cache_lock_age 10s;
            proxy_cache_lock_timeout 5s;
            proxy_cache_division $ant_cache_division;

            proxy_cache $ant_proxy_cache;
            proxy_cache_key $ant_cache_key$slice_range;
            proxy_cache_valid 200 206 730d;
            proxy_cache_valid 404 1m;

            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header Connection Keep-Alive;
            proxy_set_header X-Forwarded-For $http_x_forwarded_for;
            proxy_cache_revalidate on;

            ant_add_var ant_proxy_proto;
            
            header_filter_by_lua_file conf/header_filter.lua;
            proxy_pass $ant_proxy_proto$ant_upstream;
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 3;
        }
    }

    include admin.conf;
}
